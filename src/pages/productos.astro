---
import Layout from '../layouts/Layout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import productosData from '../data/productos.json';

const { productos, categorias, marcas } = productosData;
---

<Layout title="Productos - Suplementos">
	<Nav />
	
	<section class="relative bg-white min-h-screen py-20 overflow-hidden">

		<!-- Contenido principal -->
		<div class="relative z-10 w-4/5 mx-auto px-4 sm:px-6 lg:px-8">
			
			<!-- Título -->
			<div class="text-center mb-12">
				<h1 class="text-4xl md:text-6xl lg:text-7xl font-black text-gray-900 mb-6">
					NUESTROS
					<span class="block text-transparent bg-clip-text bg-gradient-to-r from-orange-500 via-orange-600 to-orange-700">
					PRODUCTOS
					</span>
				</h1>
				<p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
					Explora nuestra selección completa de suplementos premium diseñados para maximizar tu rendimiento.
				</p>
			</div>

			<!-- Layout principal -->
			<div class="grid lg:grid-cols-12 gap-8">
				
				<!-- Sidebar filtros -->
				<div class="lg:col-span-3">
					<div class="bg-gray-50 border border-gray-200 rounded-xl sticky top-8">
						<!-- Header filtros colapsable -->
						<button id="filter-toggle" class="w-full p-4 lg:p-6 flex items-center justify-between text-left lg:cursor-default">
							<h2 class="text-lg lg:text-xl font-black text-gray-900">Filtros</h2>
							<svg id="filter-arrow" class="w-5 h-5 text-gray-600 transform transition-transform duration-200 lg:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
							</svg>
						</button>
						
						<!-- Contenido filtros -->
						<div id="filter-content" class="px-4 pb-4 lg:px-6 lg:pb-6 lg:pt-0 hidden lg:block">
						
						<!-- Categoría -->
						<div class="mb-8">
							<h3 class="text-lg font-bold text-gray-900 mb-4">Categoría</h3>
							<div class="space-y-3">
								{categorias.map((categoria) => (
									<label class="flex items-center cursor-pointer group">
										<input type="checkbox" class="sr-only" data-category={categoria.id}>
										<div class="w-5 h-5 border-2 border-gray-400 rounded mr-3 flex items-center justify-center group-hover:border-orange-500 transition-colors duration-200">
											<div class="w-3 h-3 bg-orange-500 rounded hidden"></div>
										</div>
										<span class="text-gray-700 group-hover:text-gray-900 transition-colors duration-200">{categoria.nombre}</span>
									</label>
								))}
							</div>
						</div>

						<!-- Marca -->
						<div class="mb-8">
							<h3 class="text-lg font-bold text-gray-900 mb-4">Marca</h3>
							<div class="space-y-3">
								{marcas.map((marca) => (
									<label class="flex items-center cursor-pointer group">
										<input type="checkbox" class="sr-only" data-brand={marca.id}>
										<div class="w-5 h-5 border-2 border-gray-400 rounded mr-3 flex items-center justify-center group-hover:border-orange-500 transition-colors duration-200">
											<div class="w-3 h-3 bg-orange-500 rounded hidden"></div>
										</div>
										<span class="text-gray-700 group-hover:text-gray-900 transition-colors duration-200">{marca.nombre}</span>
									</label>
								))}
							</div>
						</div>

							<!-- Botón limpiar -->
							<button id="clearFilters" class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white py-3 text-sm font-bold uppercase tracking-wider hover:from-orange-600 hover:to-orange-700 transition-all duration-300 rounded-lg">
								Limpiar Filtros
							</button>
						</div>
					</div>
				</div>

				<!-- Productos -->
				<div class="lg:col-span-9">
					<div id="productsGrid" class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6">
						{productos.map((producto) => {
							const marcaId = marcas.find(m => m.nombre === producto.marca)?.id || producto.marca.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/g, '');
							// Usar la URL de imagen directamente sin encoding
							const imagenUrl = producto.imagen;
							return (
								<div class="product-card group relative bg-white border border-gray-200 hover:border-orange-500/50 transition-all duration-300 hover:shadow-lg rounded-lg overflow-hidden flex flex-col h-full" data-category={producto.categoria} data-brand={marcaId}>
									<div class="aspect-[4/3] sm:aspect-square bg-gradient-to-br from-gray-100 to-gray-200 overflow-hidden relative">
										<img src={imagenUrl} alt={producto.nombre} class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
										<div class="absolute inset-0 bg-gradient-to-t from-white/20 via-transparent to-transparent"></div>
									</div>
									<div class="relative p-2 sm:p-3 z-10 flex flex-col flex-grow">
										<div class="text-xs text-orange-500 font-semibold mb-0.5">{producto.marca.toUpperCase()}</div>
										<h3 class="text-sm sm:text-base font-black text-gray-900 mb-1 sm:mb-2 group-hover:text-orange-500 transition-colors duration-300 line-clamp-2">{producto.nombre}</h3>
										<p class="text-xs sm:text-sm text-gray-600 mb-1.5 sm:mb-3 group-hover:text-gray-700 transition-colors duration-300 flex-grow line-clamp-2">{producto.descripcion}</p>
										<div class="mt-auto">
											<div class="flex items-center justify-between mb-1.5 sm:mb-3">
												<div class="flex items-center space-x-2">
													{producto.precio ? (producto.precioAnterior ? (
														<div class="flex flex-col">
															<span class="text-xs text-gray-400 line-through">${producto.precioAnterior}</span>
															<span class="text-base sm:text-lg font-black text-orange-500">${producto.precio}</span>
														</div>
													) : (
														<span class="text-base sm:text-lg font-black text-orange-500">${producto.precio}</span>
													)) : null}
													{producto.descuento && (
														<span class="bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full font-bold">
															-{producto.descuento}%
														</span>
													)}
												</div>
											</div>
											<button 
												class="add-to-cart-btn w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white text-center py-1.5 sm:py-2 text-xs sm:text-sm font-bold uppercase tracking-wider hover:from-orange-600 hover:to-orange-700 transition-all duration-300 rounded-md"
												data-product-id={producto.id}
												data-product-name={producto.nombre}
												data-product-brand={producto.marca}
												data-product-category={producto.categoria}
												data-product-price={producto.precio}
												data-product-image={imagenUrl}
												data-product-description={producto.descripcion}
											>
												Agregar
											</button>
										</div>
									</div>
								</div>
							);
						})}
					</div>

					<!-- Sin productos -->
					<div id="noProducts" class="hidden text-center py-20">
						<div class="text-6xl mb-4">🔍</div>
						<h3 class="text-2xl font-black text-gray-900 mb-4">No se encontraron productos</h3>
						<p class="text-gray-600">Intenta ajustar los filtros para ver más resultados</p>
					</div>
				</div>
			</div>
		</div>
	</section>

	<Footer />
</Layout>

<!-- Script para el carrito de WhatsApp -->
<script lang="ts" src="/scripts/wsp-cart.ts"></script>

<style>
	/* Patrón de grid personalizado */
	.bg-grid-pattern {
		background-image: 
			linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
			linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
		background-size: 50px 50px;
	}

	/* Limitar líneas de texto para mantener alineación */
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
		text-overflow: ellipsis;
		min-height: 2.5rem;
	}
</style>

<script>
	import { initializeProductFilter, additionalStyles } from '../scripts/productFilter';

	// Inicialización cuando el DOM esté listo
	document.addEventListener('DOMContentLoaded', () => {
		const config = {
			filterDelay: 150,
			animationDelay: 50,
			enableSearch: false,
			enableCounts: true
		};
		
		const productFilter = initializeProductFilter(config);
		
		// Hacer disponible globalmente si es necesario
		(window as any).productFilter = productFilter;
		
		// Listener para routing
		window.addEventListener('popstate', () => {
			productFilter.resetFilters();
		});
		
		// Inyectar estilos adicionales
		const styleSheet = document.createElement('style');
		styleSheet.textContent = additionalStyles;
		document.head.appendChild(styleSheet);
		
		// Toggle de filtros para móvil
		const filterToggle = document.getElementById('filter-toggle');
		const filterContent = document.getElementById('filter-content');
		const filterArrow = document.getElementById('filter-arrow');
		
		filterToggle?.addEventListener('click', () => {
			// Solo funciona en móvil (menos de lg)
			if (window.innerWidth >= 1024) return;
			
			const isHidden = filterContent?.classList.contains('hidden');
			
			if (isHidden) {
				filterContent?.classList.remove('hidden');
				filterContent?.classList.add('block');
				filterArrow?.classList.add('rotate-180');
			} else {
				filterContent?.classList.add('hidden');
				filterContent?.classList.remove('block');
				filterArrow?.classList.remove('rotate-180');
			}
		});
		
		// Manejar resize de ventana
		window.addEventListener('resize', () => {
			if (window.innerWidth >= 1024) {
				// En desktop, siempre mostrar filtros
				filterContent?.classList.remove('hidden');
				filterContent?.classList.add('block');
				filterArrow?.classList.remove('rotate-180');
			} else {
				// En móvil, colapsar por defecto
				filterContent?.classList.add('hidden');
				filterContent?.classList.remove('block');
				filterArrow?.classList.remove('rotate-180');
			}
		});
	});
</script>

<!-- Importar y configurar el carrito de WhatsApp -->
<script src="../scripts/wsp-cart.ts"></script>